<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數學習作：花片加減法</title>
    
    <!-- 引入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 html2canvas (截圖功能) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* 防止選取文字，讓操作更像 App */
        body {
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* 防止手機上下滑動頁面 */
        }
        
        /* 自定義捲軸 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* 工具按鈕激活狀態 */
        .tool-active {
            background-color: #e0e7ff; /* indigo-100 */
            color: #4f46e5; /* indigo-600 */
            ring: 2px solid #818cf8;
        }
        
        /* 顏色按鈕激活狀態 */
        .color-active {
            transform: scale(1.1);
            border-color: #6366f1;
        }

        /* 花片樣式 */
        .flower-item {
            position: absolute;
            width: 80px; /* 大尺寸 80px */
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
            touch-action: none;
        }
        
        .cursor-mode .flower-item { cursor: grab; }
        .cursor-mode .flower-item:active { cursor: grabbing; transform: scale(1.05); }
        .eraser-mode .flower-item { cursor: crosshair; }
        .eraser-mode .flower-item:hover { opacity: 0.5; transform: scale(0.9); }
        .pen-mode .flower-item { pointer-events: none; opacity: 0.9; }

        /* 動畫 */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-amber-50 h-screen flex flex-col overflow-hidden font-sans">

    <!-- Header -->
    <header class="bg-white p-3 shadow-sm flex items-center justify-between z-10 shrink-0">
        <div class="flex items-center gap-2">
           <div class="bg-indigo-500 text-white p-2 rounded-lg">
             <!-- Plus Icon -->
             <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
           </div>
           <h1 class="text-xl font-bold text-slate-700 tracking-wide">數學習作：花片加減法</h1>
        </div>
        
        <button id="btn-screenshot" class="flex items-center gap-2 bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-full font-bold shadow-sm transition-all active:scale-95">
             <!-- Download Icon -->
             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
             <span>下載成果</span>
        </button>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar Tools -->
        <aside class="w-20 bg-white shadow-md flex flex-col items-center py-4 gap-4 z-10 border-r border-slate-100 overflow-y-auto custom-scrollbar shrink-0">
            <div class="flex flex-col gap-2 w-full px-2">
                <span class="text-xs text-center text-slate-400 font-bold mb-1">工具</span>
                
                <button id="tool-cursor" class="p-3 rounded-xl flex flex-col items-center gap-1 transition-all tool-active" onclick="setMode('cursor')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m4.034 16.517 4.757-4.756"/><path d="M16 20c0-1.105-.895-2-2-2s-2 .895-2 2 .895 2 2 2 2-.895 2-2Z"/><path d="M6 6v8h2"/><path d="m15.474 12.457 1.06 1.061"/><path d="m11.516 16.415 1.06 1.06"/><path d="M19.98 11.96 12 4.02l-8 8L9.676 17.7a2.002 2.002 0 0 0 2.828 0l7.476-5.74Z"/></svg>
                    <span class="text-[10px] font-bold">移動</span>
                </button>

                <button id="tool-pen" class="p-3 rounded-xl flex flex-col items-center gap-1 transition-all text-slate-500 hover:bg-slate-100" onclick="setMode('pen')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                    <span class="text-[10px] font-bold">畫筆</span>
                </button>

                <button id="tool-eraser" class="p-3 rounded-xl flex flex-col items-center gap-1 transition-all text-slate-500 hover:bg-slate-100" onclick="setMode('eraser')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>
                    <span class="text-[10px] font-bold">橡皮擦</span>
                </button>
            </div>

            <div class="w-full border-t border-slate-100 my-1"></div>

            <!-- Color Picker (Hidden by default) -->
            <div id="color-picker-container" class="flex flex-col gap-2 w-full px-2 hidden animate-fade-in">
               <span class="text-xs text-center text-slate-400 font-bold">顏色</span>
               <div class="flex flex-wrap justify-center gap-2">
                  <button class="color-btn w-6 h-6 rounded-full border-2 border-indigo-500 scale-110" style="background-color: #333333;" onclick="setPenColor('#333333', this)"></button>
                  <button class="color-btn w-6 h-6 rounded-full border-2 border-transparent" style="background-color: #ef4444;" onclick="setPenColor('#ef4444', this)"></button>
                  <button class="color-btn w-6 h-6 rounded-full border-2 border-transparent" style="background-color: #3b82f6;" onclick="setPenColor('#3b82f6', this)"></button>
                  <button class="color-btn w-6 h-6 rounded-full border-2 border-transparent" style="background-color: #10b981;" onclick="setPenColor('#10b981', this)"></button>
               </div>
            </div>

            <div class="mt-auto flex flex-col gap-3 w-full px-2">
                 <button onclick="undoLastLine()" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg flex flex-col items-center" title="復原筆畫">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                    <span class="text-[10px]">復原</span>
                 </button>
                 <button onclick="clearCanvas()" class="p-2 text-red-400 hover:bg-red-50 rounded-lg flex flex-col items-center" title="清除筆跡">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                    <span class="text-[10px]">清空筆跡</span>
                 </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col relative bg-slate-100 p-4 min-w-0">
            
            <!-- Whiteboard Area -->
            <div id="stage-container" class="flex-1 bg-white rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden cursor-mode touch-none"
                 style="background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;">
                
                <!-- Flowers Layer -->
                <div id="flowers-layer" class="absolute inset-0 z-10 w-full h-full"></div>

                <!-- Drawing Canvas -->
                <canvas id="drawing-canvas" class="absolute inset-0 z-20 pointer-events-none w-full h-full"></canvas>

                <!-- Empty State Hint -->
                <div id="empty-hint" class="absolute inset-0 flex items-center justify-center opacity-30 pointer-events-none select-none">
                   <div class="text-center">
                     <p class="text-4xl font-bold text-slate-300 mb-2">從下方加入花片</p>
                     <p class="text-xl text-slate-300">或使用畫筆開始書寫</p>
                   </div>
                </div>
            </div>

            <!-- Bottom Controls -->
            <div class="h-24 mt-4 bg-white rounded-2xl shadow-sm p-2 flex items-center justify-between px-6 gap-8 shrink-0 overflow-x-auto">
                <div class="flex items-center gap-6">
                     <!-- Red Generator -->
                     <div class="flex flex-col items-center gap-1 group">
                        <div class="bg-red-50 p-2 rounded-xl flex gap-2 border border-red-100">
                           <button onclick="addFlower('red')" class="w-16 h-16 bg-white rounded-lg shadow-sm border border-red-100 flex items-center justify-center hover:bg-red-50 active:scale-95 transition-all relative overflow-hidden">
                             <div class="w-8 h-8 rounded-full bg-red-500 border-2 border-white shadow-sm ring-1 ring-red-200"></div>
                             <span class="absolute text-[10px] font-bold text-red-800 bottom-1">增加</span>
                           </button>
                        </div>
                     </div>

                     <!-- Blue Generator -->
                     <div class="flex flex-col items-center gap-1 group">
                        <div class="bg-blue-50 p-2 rounded-xl flex gap-2 border border-blue-100">
                           <button onclick="addFlower('blue')" class="w-16 h-16 bg-white rounded-lg shadow-sm border border-blue-100 flex items-center justify-center hover:bg-blue-50 active:scale-95 transition-all relative overflow-hidden">
                             <div class="w-8 h-8 rounded-full bg-blue-500 border-2 border-white shadow-sm ring-1 ring-blue-200"></div>
                             <span class="absolute text-[10px] font-bold text-blue-800 bottom-1">增加</span>
                           </button>
                        </div>
                     </div>
                </div>

                <!-- Trash -->
                <div class="flex items-center gap-4">
                     <div class="h-12 w-[1px] bg-slate-200 mx-2"></div>
                     <button onclick="clearAllFlowers()" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl text-slate-400 hover:text-red-500 hover:bg-red-50 transition-colors" title="清除所有花片">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        <span class="text-xs font-bold mt-1">清空花片</span>
                     </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Application Logic (Vanilla JS) -->
    <script>
        // --- State ---
        const state = {
            mode: 'cursor', // 'cursor', 'pen', 'eraser'
            penColor: '#333333',
            penSize: 4,
            items: [], // {id, color, x, y}
            lines: [], // {tool, color, size, points: []}
            isDragging: false,
            dragId: null,
            dragOffset: {x: 0, y: 0},
            currentLine: null
        };

        // --- DOM Elements ---
        const stageContainer = document.getElementById('stage-container');
        const flowersLayer = document.getElementById('flowers-layer');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const emptyHint = document.getElementById('empty-hint');
        const colorPickerContainer = document.getElementById('color-picker-container');

        // --- Init ---
        function resizeCanvas() {
            canvas.width = stageContainer.clientWidth;
            canvas.height = stageContainer.clientHeight;
            redrawCanvas();
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100); // Initial resize

        // --- Tools ---
        function setMode(mode) {
            state.mode = mode;
            
            // UI Updates
            document.querySelectorAll('aside button[id^="tool-"]').forEach(btn => {
                btn.classList.remove('tool-active', 'bg-indigo-100', 'text-indigo-600', 'ring-2', 'ring-indigo-400');
                btn.classList.add('text-slate-500', 'hover:bg-slate-100');
            });
            
            const activeBtn = document.getElementById(`tool-${mode}`);
            activeBtn.classList.remove('text-slate-500', 'hover:bg-slate-100');
            activeBtn.classList.add('tool-active');

            // Show/Hide Color Picker
            if (mode === 'pen') {
                colorPickerContainer.classList.remove('hidden');
            } else {
                colorPickerContainer.classList.add('hidden');
            }

            // Cursor & Pointer Events Logic
            stageContainer.className = `flex-1 bg-white rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden touch-none ${mode}-mode`;
            
            if (mode === 'cursor') {
                canvas.classList.add('pointer-events-none');
                canvas.classList.remove('pointer-events-auto');
                stageContainer.style.cursor = 'default';
            } else if (mode === 'eraser') {
                canvas.classList.remove('pointer-events-none');
                canvas.classList.add('pointer-events-auto');
                stageContainer.style.cursor = 'cell';
            } else {
                canvas.classList.remove('pointer-events-none');
                canvas.classList.add('pointer-events-auto');
                stageContainer.style.cursor = 'crosshair';
            }
        }

        function setPenColor(color, btn) {
            state.penColor = color;
            document.querySelectorAll('.color-btn').forEach(b => {
                b.classList.remove('border-indigo-500', 'scale-110');
                b.classList.add('border-transparent');
            });
            btn.classList.remove('border-transparent');
            btn.classList.add('border-indigo-500', 'scale-110');
        }

        // --- Flower Logic ---
        function addFlower(color) {
            const id = Date.now();
            const flower = {
                id,
                color,
                x: 50 + Math.random() * 100,
                y: 150 + Math.random() * 100
            };
            state.items.push(flower);
            renderFlower(flower);
            updateEmptyHint();
        }

        function renderFlower(item) {
            const el = document.createElement('div');
            el.id = `flower-${item.id}`;
            el.className = 'flower-item';
            el.style.transform = `translate(${item.x}px, ${item.y}px)`;
            
            // Flower SVG
            const fillColor = item.color === 'red' ? '#ef4444' : '#3b82f6';
            el.innerHTML = `
                <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md pointer-events-none">
                    <path d="M50 25 C50 10 35 10 35 25 C20 25 20 40 35 40 C20 40 20 55 35 55 C35 70 50 70 50 55 C50 70 65 70 65 55 C80 55 80 40 65 40 C80 40 80 25 65 25 C65 10 50 10 50 25 Z" fill="${fillColor}" stroke="white" stroke-width="3" />
                    <circle cx="50" cy="40" r="10" fill="#fbbf24" />
                </svg>
            `;

            // Pointer Events for Flower
            el.addEventListener('pointerdown', (e) => {
                if (state.mode === 'eraser') {
                    e.stopPropagation();
                    removeFlower(item.id);
                } else if (state.mode === 'cursor') {
                    e.stopPropagation();
                    startDrag(e, item.id);
                }
            });

            flowersLayer.appendChild(el);
        }

        function removeFlower(id) {
            state.items = state.items.filter(i => i.id !== id);
            const el = document.getElementById(`flower-${id}`);
            if (el) el.remove();
            updateEmptyHint();
        }

        function clearAllFlowers() {
            state.items = [];
            flowersLayer.innerHTML = '';
            updateEmptyHint();
        }

        function updateEmptyHint() {
            if (state.items.length === 0 && state.lines.length === 0) {
                emptyHint.style.display = 'flex';
            } else {
                emptyHint.style.display = 'none';
            }
        }

        // --- Drag Logic ---
        function startDrag(e, id) {
            const item = state.items.find(i => i.id === id);
            if (!item) return;

            const rect = stageContainer.getBoundingClientRect();
            // Calculate offset based on the click position relative to the item's current position
            // But item.x/y is relative to container top-left.
            // Mouse clientX is global.
            // Item screen pos = rect.left + item.x
            // Offset = Mouse - Item screen pos
            
            state.isDragging = true;
            state.dragId = id;
            
            // More accurate offset calculation
            const el = document.getElementById(`flower-${id}`);
            const elRect = el.getBoundingClientRect();
            state.dragOffset = {
                x: e.clientX - elRect.left,
                y: e.clientY - elRect.top
            };
            
            el.style.zIndex = 50; // Bring to front
            el.style.cursor = 'grabbing';
        }

        // --- Drawing & Global Pointer Events ---
        stageContainer.addEventListener('pointerdown', (e) => {
            if (state.mode === 'cursor') return;
            
            const rect = stageContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            state.currentLine = {
                tool: state.mode,
                color: state.mode === 'eraser' ? '#ffffff' : state.penColor,
                size: state.mode === 'eraser' ? 30 : state.penSize,
                points: [{x, y}]
            };
            
            redrawCanvas(); // Start drawing immediately
        });

        window.addEventListener('pointermove', (e) => {
            const rect = stageContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Dragging
            if (state.isDragging && state.mode === 'cursor' && state.dragId) {
                let newX = x - state.dragOffset.x;
                let newY = y - state.dragOffset.y;

                // Boundary (80px item)
                newX = Math.max(0, Math.min(newX, rect.width - 80));
                newY = Math.max(0, Math.min(newY, rect.height - 80));

                // Update Data
                const item = state.items.find(i => i.id === state.dragId);
                if (item) {
                    item.x = newX;
                    item.y = newY;
                    // Update DOM
                    const el = document.getElementById(`flower-${state.dragId}`);
                    if (el) el.style.transform = `translate(${newX}px, ${newY}px)`;
                }
            }

            // Drawing
            if (state.currentLine) {
                state.currentLine.points.push({x, y});
                redrawCanvas();
            }
        });

        window.addEventListener('pointerup', () => {
            // End Drag
            if (state.isDragging) {
                const el = document.getElementById(`flower-${state.dragId}`);
                if (el) {
                    el.style.zIndex = '';
                    el.style.cursor = '';
                }
                state.isDragging = false;
                state.dragId = null;
            }

            // End Draw
            if (state.currentLine) {
                state.lines.push(state.currentLine);
                state.currentLine = null;
                updateEmptyHint();
                redrawCanvas();
            }
        });

        // --- Canvas Rendering ---
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            const drawLine = (line) => {
                ctx.beginPath();
                ctx.lineWidth = line.size;
                ctx.strokeStyle = line.tool === 'eraser' ? 'rgba(255,255,255,1)' : line.color;
                
                if (line.tool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                }

                if (line.points.length > 0) {
                    ctx.moveTo(line.points[0].x, line.points[0].y);
                    for (let i = 1; i < line.points.length; i++) {
                        ctx.lineTo(line.points[i].x, line.points[i].y);
                    }
                }
                ctx.stroke();
            };

            // Draw saved lines
            state.lines.forEach(drawLine);
            // Draw current line
            if (state.currentLine) drawLine(state.currentLine);
        }

        function undoLastLine() {
            state.lines.pop();
            redrawCanvas();
            updateEmptyHint();
        }

        function clearCanvas() {
            state.lines = [];
            redrawCanvas();
            updateEmptyHint();
        }

        // --- Screenshot ---
        document.getElementById('btn-screenshot').addEventListener('click', () => {
            if (!window.html2canvas) {
                alert("截圖功能載入失敗");
                return;
            }
            // Ensure no selection tools are visible if we had any
            html2canvas(stageContainer, {
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `數學花片練習-${new Date().toLocaleTimeString('zh-TW', {hour12: false}).replace(/:/g, '')}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        // Initialize empty state
        updateEmptyHint();
        
    </script>
</body>
</html>